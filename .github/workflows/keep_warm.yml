name: Supabase Keep Warm

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정 실행
  workflow_dispatch:

jobs:
  ping_db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # [핵심 수정] IPv6를 끄지 않고, IPv4를 '최우선'으로 사용하도록 순서만 바꿉니다.
      # 이 설정이 있어야 "Network is unreachable" 에러가 사라집니다.
      - name: Prefer IPv4 over IPv6
        run: |
          sudo sed -i 's/#precedence ::ffff:0:0\/96  100/precedence ::ffff:0:0\/96  100/' /etc/gai.conf

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Execute SQL Query
        env:
          DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # 6543 포트를 그대로 사용하며, 위 설정 덕분에 IPv4로 안정적으로 접속합니다.
          psql "$DB_URL" -c "SELECT NOW();"
