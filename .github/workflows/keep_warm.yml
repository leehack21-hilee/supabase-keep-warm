name: Supabase Keep Warm (Multi)

on:
  schedule:
    - cron: '0 15 * * *' # ë§¤ì¼ ìì • ì‹¤í–‰
  workflow_dispatch:

jobs:
  wake_up_all:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up all projects
        env:
          # ì•„ê¹Œ ë§Œë“  ëª©ë¡(Secret)ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
          PROJECTS_LIST: ${{ secrets.SUPABASE_PROJECTS }}
        run: |
          # 1. ëª©ë¡ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$PROJECTS_LIST" ]; then
            echo "âŒ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Secretì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi

          # 2. í•œ ì¤„ì”© ì½ìœ¼ë©´ì„œ ë°˜ë³µë¬¸(Loop) ì‹¤í–‰
          echo "$PROJECTS_LIST" | while read -r line; do
            # ë¹ˆ ì¤„ì€ ë¬´ì‹œ
            if [ -z "$line" ]; then continue; fi

            # ê³µë°±ì„ ê¸°ì¤€ìœ¼ë¡œ URLê³¼ KEYë¥¼ ìª¼ê°­ë‹ˆë‹¤.
            URL=$(echo "$line" | awk '{print $1}')
            KEY=$(echo "$line" | awk '{print $2}')

            echo "---------------------------------------------------"
            echo "ğŸš€ Waking up: $URL"

            # 3. ìš”ì²­ ì „ì†¡ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ -f ì˜µì…˜ ì‚¬ìš©)
            response=$(curl -s -o /dev/null -w "%{http_code}" -X GET "$URL/rest/v1/" \
              -H "apikey: $KEY" \
              -H "Authorization: Bearer $KEY")

            # 4. ê²°ê³¼ í™•ì¸
            if [ "$response" -eq 200 ]; then
              echo "âœ… Success! Supabase is active. (Status: 200)"
            else
              echo "âš ï¸ Failed! (Status: $response) - í‚¤ë‚˜ ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”."
              # ì—¬ê¸°ì„œ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ í”„ë¡œì íŠ¸ë¥¼ ìœ„í•´ ë©ˆì¶”ì§€ ì•Šê³  ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.
            fi
          done
          
          echo "---------------------------------------------------"
          echo "ğŸ‰ ëª¨ë“  ì‘ì—… ì™„ë£Œ."
